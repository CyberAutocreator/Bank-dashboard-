// Demo state
let demoState = {
  balances: {
    "Checking": 162515673.60,
    "Premium Checking": 36114594.13,
    "Savings": 36114594.13,
    "Family Savings": 36114594.13
  },
  tx: [
    {date:"2025-10-01",account:"Checking",type:"Deposit",desc:"Wire transfer",amt:50000000,bal:162515673.60},
    {date:"2025-10-15",account:"Premium Checking",type:"Withdrawal",desc:"Property investment",amt:-5000000,bal:31114594.13},
    {date:"2025-09-20",account:"Family Savings",type:"Withdrawal",desc:"Family expenses",amt:-2000000,bal:34114594.13}
  ],
  user: null
};

// Login/Register just unlock dashboard
document.getElementById('loginBtn').addEventListener('click', ()=>{
  const usr = document.getElementById('user').value.trim() || "Demo User";
  demoState.user = usr;
  document.getElementById('custName').textContent = usr;
  document.getElementById('loginCard').style.display='none';
  document.getElementById('dashboard').style.display='';
  renderBalances(); renderTx(); renderChart();
});
document.getElementById('registerBtn').addEventListener('click', ()=>{
  document.getElementById('loginBtn').click(); // same as login
});
document.getElementById('biometric').addEventListener('click', ()=>{
  demoState.user = "biometric.user";
  document.getElementById('custName').textContent = demoState.user;
  document.getElementById('loginCard').style.display='none';
  document.getElementById('dashboard').style.display='';
  renderBalances(); renderTx(); renderChart();
});

// Render functions
function renderBalances(){
  const mapping = {"Checking":"b-check","Premium Checking":"b-premium","Savings":"b-savings","Family Savings":"b-family"};
  let total=0;
  for(const [name,val] of Object.entries(demoState.balances)){
    document.getElementById(mapping[name]).textContent = formatUSD(val);
    total+=val;
  }
  document.getElementById('b-total').textContent = formatUSD(total);
}
function renderTx(){
  const tbody=document.getElementById('txBody'); tbody.innerHTML="";
  demoState.tx.slice().reverse().forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.date}</td><td>${t.account}</td><td>${t.type}</td><td>${t.desc}</td><td class="right">${formatUSD(t.amt)}</td><td class="right">${formatUSD(t.bal)}</td>`;
    tbody.appendChild(tr);
  });
}
function renderChart(){
  const ctx=document.getElementById('balanceChart');
  if(window.chart) window.chart.destroy();
  window.chart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(demoState.balances),datasets:[{data:Object.values(demoState.balances),backgroundColor:['#06b6d4','#0ea5a0','#7dd3fc','#60a5fa']}]},options:{plugins:{legend:{labels:{color:'#cfeff3'}}}}});
}
function formatUSD(n){ return Number(n).toLocaleString("en-US",{style:"currency",currency:"USD"}); }

// Transfer updates local state
document.getElementById('confirmTransfer').addEventListener('click', ()=>{
  const from=document.getElementById('fromAcc').value;
  const to=document.getElementById('toAcc').value;
  const amt=Number(document.getElementById('amt').value);
  if(from===to || amt<=0 || demoState.balances[from]<amt){ document.getElementById('transferError').textContent="Invalid transfer"; document.getElementById('transferError').style.display='block'; return; }
  demoState.balances[from]-=amt; demoState.balances[to]+=amt;
  const today=new Date().toISOString().slice(0,10);
  demoState.tx.push({date:today,account:from,type:"Transfer",desc:`Transfer to ${to}`,amt:-amt,bal:demoState.balances[from]});
  demoState.tx.push({date:today,account:to,type:"Transfer",desc:`Transfer from ${from}`,amt:amt,bal:demoState.balances[to]});
  renderBalances(); renderTx(); renderChart();
  document.getElementById('transferModal').style.display='none';
  document.getElementById('amt').value='';
});
